# http://goreleaser.com
project_name: zlifecycle-event-service

archives:
  - format: zip
    wrap_in_directory: "false"
    replacements:
      darwin: macos
      amd64: x86_64
    files:
      - none*

changelog:
  use: "github"

checksum:
  name_template: "checksums.txt"

dockers:
  - image_templates:
      - "{{ .Env.ECR_REPO }}/{{ .ProjectName }}:{{ .Major }}"
      - "{{ .Env.ECR_REPO }}/{{ .ProjectName }}:{{ .Major }}.{{ .Minor }}"
      - "{{ .Env.ECR_REPO }}/{{ .ProjectName }}:{{ .Major }}.{{ .Minor }}.{{ .Patch }}"
      - "{{ .Env.ECR_REPO }}/{{ .ProjectName }}:latest"
    build_flag_templates:
      - "--label=org.opencontainers.image.created={{ .Date }}"
      - "--label=org.opencontainers.image.title={{ .ProjectName }}"
      - "--label=org.opencontainers.image.revision={{ .FullCommit }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"
      - "--label=org.opencontainers.image.vendor=CompuZest"
    dockerfile: ./deployments/Dockerfile
    extra_files:
      - db/migrations

dist: "build/dist"

release:
  draft: false
  header: |
    ## {{ .Version }} ({{ .Date }})
    See https://github.com/cloudknit-io/cloudknit/event-service for download links and documentation
    ## Main downloads
    - [Linux Intel 64 bit](https://github.com/cloudknit-io/cloudknit/event-service/releases/download/{{ .Tag }}/{{ .ProjectName }}_{{ .Version }}_linux_x86_64.zip)
    - [MacOS Universal](https://github.com/cloudknit-io/cloudknit/event-service/releases/download/{{ .Tag }}/{{ .ProjectName }}_{{ .Version }}_macos_all.zip)
    - [Windows Intel 64 bit](https://github.com/cloudknit-io/cloudknit/event-service/releases/download/{{ .Tag }}/{{ .ProjectName }}_{{ .Version }}_windows_x86_64.zip)
    ## Docker images
    - `docker pull {{ .Env.ECR_REPO }}/{{ .ProjectName }}:{{ .Major }}`
    - `docker pull {{ .Env.ECR_REPO }}/{{ .ProjectName }}:{{ .Major }}.{{ .Minor }}`
    - `docker pull {{ .Env.ECR_REPO }}/{{ .ProjectName }}:{{ .Major }}.{{ .Minor }}.{{ .Patch }}`
    - `docker pull {{ .Env.ECR_REPO }}/{{ .ProjectName }}:latest"`

snapshot:
  name_template: "{{ .Tag }}"

source:
  enabled: true
  name_template: "{{ .ProjectName }}_{{ .Version }}_source"
  format: "zip"

universal_binaries:
  - id: "darwin"
    replace: false
    name_template: '{{ .ProjectName }}'

builds:
  - id: "darwin"
    main: "./cmd/zlifecycle-event-service"
    goos:
      - darwin
    goarch:
      - amd64
      - arm64
    mod_timestamp: "{{ .CommitTimestamp }}"

  - id: "linux"
    main: "./cmd/zlifecycle-event-service"
    goos:
      - linux
    goarch:
      - amd64
      - arm64
    mod_timestamp: "{{ .CommitTimestamp }}"

  - id: "windows"
    main: "./cmd/zlifecycle-event-service"
    goos:
      - windows
    goarch:
      - amd64
    mod_timestamp: "{{ .CommitTimestamp }}"

announce:
  slack:
    enabled: true
    message_template: "*zLifecycle Event Service* `{{ .Tag }}` has been released from the `{{ .Branch }}` branch at commit `{{ .ShortCommit }}` ({{ .CommitDate }})\nhttps://github.com/cloudknit-io/cloudknit/event-service/releases/tag/{{ .Tag }}\n\n{{ .ReleaseNotes }}"
