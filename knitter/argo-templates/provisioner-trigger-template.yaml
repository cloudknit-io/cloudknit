# Copyright (C) 2020 CompuZest, Inc. - All Rights Reserved
#
# Unauthorized copying of this file, via any medium, is strictly prohibited
# Proprietary and confidential
#
# NOTICE: All information contained herein is, and remains the property of
# CompuZest, Inc. The intellectual and technical concepts contained herein are
# proprietary to CompuZest, Inc. and are protected by trade secret or copyright
# law. Dissemination of this information or reproduction of this material is
# strictly forbidden unless prior written permission is obtained from CompuZest, Inc.
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: provisioner-trigger-template
  namespace: argocd
spec:
  entrypoint: run
  podGC:
    strategy: OnWorkflowSuccess
  ttlStrategy:
    secondsAfterSuccess: 600
    secondsAfterCompletion: 600
  templates:
    - name: run
      inputs:
        parameters:
          - name: terraform_version
          - name: terraform_il_path
          - name: il_repo
          - name: workflowtemplate
      resource:
        action: create
        manifest: |
          apiVersion: argoproj.io/v1alpha1
          kind: Workflow
          metadata:
            generateName: experimental-wow
            namespace: argocd
            labels:
              terraform/sync: 'true'
          spec:
            arguments:
              parameters:
              - name: terraform_version
                value: {{inputs.parameters.terraform_version}}
              - name: terraform_il_path
                value: {{inputs.parameters.terraform_il_path}}
              - name: il_repo
                value: {{inputs.parameters.il_repo}}
            workflowTemplateRef:
              name: {{inputs.parameters.workflowtemplate}}
        successCondition: status.phase == Succeeded
        failureCondition: status.phase in (Failed, Error)
